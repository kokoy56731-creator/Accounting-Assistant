<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="记账助手">
  <title>记账助手</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/10605/10605942.png" type="image/png" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#07c160', // WeChat Green
            primaryDark: '#06ad56',
            background: '#f7f7f7', // WeChat Gray
            surface: '#ffffff',
            textMain: '#111111',
            textSub: '#7f7f7f',
          },
          boxShadow: {
            'card': '0 1px 2px rgba(0, 0, 0, 0.05)',
            'nav': '0 -1px 1px rgba(0,0,0,0.05)',
            'float': '0 4px 16px rgba(7, 193, 96, 0.3)'
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- React Dependencies -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  
  <!-- Recharts -->
  <script crossorigin src="https://unpkg.com/recharts@2.12.2/umd/Recharts.js"></script>
  
  <!-- Babel -->
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { 
      -webkit-tap-highlight-color: transparent; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f7f7f7;
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior-y: none;
    }
    /* Hide scrollbar */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    /* Animations */
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    .animate-scale-in { animation: scaleIn 0.15s ease-out; }

    /* Utilities */
    .pb-safe { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); } /* Content padding to avoid nav overlap */
    .pb-safe-extra { padding-bottom: calc(6rem + env(safe-area-inset-bottom)); }
    .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
    
    /* Input Reset */
    input, select { -webkit-appearance: none; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.0",
    "@heroicons/react/": "https://aistudiocdn.com/@heroicons/react@^2.2.0/"
  }
}
</script>
</head>
<body class="text-slate-800 antialiased select-none">
  <div id="root"></div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
      });
    }
  </script>

  <!-- Main Application Code -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const Recharts = window.Recharts || {};
    const { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

    // --- ICONS (Outline & Solid sets for WeChat style) ---
    const Icons = {
      Outline: {
        Home: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>,
        Box: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>,
        PlusCircle: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>, 
        Clock: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      },
      Solid: {
        Home: (props) => <svg viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M11.47 3.84a1.5 1.5 0 012.12 0l9.47 9.47c.362.363.355.92-.04 1.255a1.25 1.25 0 01-1.157.376L21 14.902V19.5a2.25 2.25 0 01-2.25 2.25h-3.75a.75.75 0 01-.75-.75V15h-4.5v6a.75.75 0 01-.75.75H5.25A2.25 2.25 0 013 19.5v-4.598c0-.527.185-1.01.492-1.376a1.25 1.25 0 01-.202-1.442c.395-.335.954-.328 1.316.034l6.864-6.864z" /></svg>,
        Box: (props) => <svg viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M3.375 3C2.339 3 1.5 3.84 1.5 4.875v.75c0 1.036.84 1.875 1.875 1.875h17.25c1.035 0 1.875-.84 1.875-1.875v-.75C22.5 3.839 21.66 3 20.625 3H3.375z" /><path fillRule="evenodd" d="M3.087 9l.54 9.176A3 3 0 006.62 21h10.757a3 3 0 002.995-2.824L20.913 9H3.087zm6.163 3.75A.75.75 0 0110 12h4a.75.75 0 010 1.5h-4a.75.75 0 01-.75-.75z" clipRule="evenodd" /></svg>,
        PlusCircle: (props) => <svg viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" /></svg>,
        Clock: (props) => <svg viewBox="0 0 24 24" fill="currentColor" {...props}><path fillRule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clipRule="evenodd" /></svg>,
      },
      Common: {
        Plus: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>,
        Trash: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>,
        XMark: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>,
        Settings: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>,
        ArrowDown: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
        ArrowUp: (props) => <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
      }
    };

    // --- UTILS ---
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
    const formatCurrency = (val) => new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(val);
    const exportData = (data, filename) => {
      const link = document.createElement("a");
      link.href = `data:text/json;chatset=utf-8,${encodeURIComponent(JSON.stringify(data))}`;
      link.download = `${filename}.json`;
      link.click();
    };

    // --- UI COMPONENTS ---
    const Card = ({ children, className = '', onClick }) => (
      <div onClick={onClick} className={`bg-white rounded-xl shadow-card p-5 ${className}`}>{children}</div>
    );

    const ModalSheet = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex flex-col justify-end">
          <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={onClose} />
          <div className="relative bg-white rounded-t-2xl p-5 shadow-2xl animate-slide-up pb-safe max-h-[85vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-bold text-slate-800">{title}</h3>
              <button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><Icons.Common.XMark className="w-5 h-5"/></button>
            </div>
            {children}
          </div>
        </div>
      );
    };

    const FAB = ({ onClick, icon }) => (
      <button onClick={onClick} className="fixed right-5 bottom-24 w-14 h-14 bg-primary text-white rounded-full shadow-float flex items-center justify-center active:scale-90 transition-transform z-30">
        {icon}
      </button>
    );

    const Input = ({ label, className = '', ...props }) => (
      <div className="mb-4">
        {label && <label className="block text-sm font-medium text-slate-500 mb-1.5 ml-1">{label}</label>}
        <input className={`w-full px-4 py-3.5 bg-slate-50 border border-transparent rounded-xl focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base transition-all ${className}`} {...props} />
      </div>
    );

    const Select = ({ label, className = '', children, ...props }) => (
      <div className="mb-4">
        {label && <label className="block text-sm font-medium text-slate-500 mb-1.5 ml-1">{label}</label>}
        <select className={`w-full px-4 py-3.5 bg-slate-50 border border-transparent rounded-xl focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none text-base bg-white transition-all appearance-none ${className}`} {...props}>
          {children}
        </select>
      </div>
    );

    const Button = ({ children, className = '', ...props }) => (
      <button className={`px-4 py-3 rounded-xl font-bold transition-all active:scale-[0.98] ${className}`} {...props}>
        {children}
      </button>
    );
    
    const Badge = ({ children, color }) => {
       const colors = { green: 'bg-green-100 text-green-700', red: 'bg-red-100 text-red-700', gray: 'bg-slate-100 text-slate-600' };
       return <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${colors[color]||colors.gray}`}>{children}</span>
    };

    // --- VIEWS ---

    // 1. Dashboard
    const DashboardView = ({ products, sales }) => {
      const stats = useMemo(() => {
        const profit = sales.reduce((sum, s) => sum + s.profit, 0);
        const revenue = sales.reduce((sum, s) => sum + s.totalSellPrice, 0);
        const stockCost = products.reduce((sum, p) => sum + (p.currentQuantity * p.costPrice), 0);
        const soldCount = sales.reduce((sum, s) => sum + s.quantity, 0);
        
        const chartMap = new Map();
        for(let i=6; i>=0; i--) {
           const d = new Date(); d.setDate(d.getDate() - i);
           const k = d.toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
           chartMap.set(k, 0);
        }
        sales.forEach(s => {
          const k = new Date(s.soldAt).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
          if(chartMap.has(k)) chartMap.set(k, chartMap.get(k) + s.profit);
        });
        const chartData = Array.from(chartMap.entries()).map(([date, profit]) => ({date, profit}));
        return { profit, revenue, stockCost, soldCount, chartData, hasSales: sales.length > 0 };
      }, [products, sales]);

      return (
        <div className="px-4 pb-safe space-y-5 animate-fade-in">
           <div className="grid grid-cols-2 gap-3 mt-4">
              <Card className="bg-gradient-to-br from-[#07c160] to-[#059669] text-white shadow-lg shadow-emerald-100 col-span-2">
                 <div className="flex flex-col items-center py-2">
                    <div className="text-emerald-100 text-sm font-medium mb-1">累计总利润</div>
                    <div className="text-4xl font-bold tracking-tight">{formatCurrency(stats.profit)}</div>
                 </div>
              </Card>
              <Card className="bg-white">
                 <div className="text-slate-400 text-xs font-medium mb-1">销售额</div>
                 <div className="text-xl font-bold text-slate-800">{formatCurrency(stats.revenue)}</div>
              </Card>
              <Card className="bg-white">
                 <div className="text-slate-400 text-xs font-medium mb-1">库存成本</div>
                 <div className="text-xl font-bold text-slate-800">{formatCurrency(stats.stockCost)}</div>
              </Card>
           </div>

           <Card className="h-64 flex flex-col">
              <h3 className="text-slate-800 font-bold text-sm mb-4">近七日趋势</h3>
              <div className="flex-1 w-full min-h-0 relative">
                {stats.hasSales ? (
                   <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={stats.chartData} margin={{top:5, right:0, left:-20, bottom:0}}>
                      <defs>
                        <linearGradient id="colorProfit" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#07c160" stopOpacity={0.2}/>
                          <stop offset="95%" stopColor="#07c160" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9"/>
                      <XAxis dataKey="date" tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} tickMargin={10} />
                      <YAxis tick={{fontSize: 10, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                      <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow:'0 4px 12px rgba(0,0,0,0.08)'}} />
                      <Area type="monotone" dataKey="profit" stroke="#07c160" strokeWidth={2} fillOpacity={1} fill="url(#colorProfit)" />
                    </AreaChart>
                   </ResponsiveContainer>
                ) : (
                  <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-300">
                     <p className="text-xs">暂无数据</p>
                  </div>
                )}
              </div>
           </Card>
        </div>
      );
    };

    // 2. Inventory
    const InventoryView = ({ products, onAdd, onDelete }) => {
      const [isModalOpen, setModalOpen] = useState(false);
      const [form, setForm] = useState({ name: '', cost: '', qty: '' });

      const handleSubmit = () => {
        if(!form.name || !form.cost || !form.qty) return;
        onAdd({ name: form.name, costPrice: Number(form.cost), initialQuantity: Number(form.qty) });
        setForm({ name: '', cost: '', qty: '' });
        setModalOpen(false);
      };

      return (
        <div className="pb-safe min-h-screen">
          <header className="px-5 py-3 sticky top-0 z-20 bg-background/95 backdrop-blur border-b border-slate-200/50 flex justify-between items-center h-[50px] mb-2">
             <h1 className="text-lg font-bold text-slate-900">库存管理</h1>
          </header>
          
          <div className="px-4 space-y-3">
             {products.length === 0 && (
               <div className="text-center py-20 text-slate-400">
                  <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Icons.Outline.Box className="w-8 h-8 text-slate-300"/>
                  </div>
                  <p className="text-sm">暂无商品</p>
               </div>
             )}
             {products.map(p => (
               <Card key={p.id} className="flex justify-between items-center relative overflow-hidden active:bg-slate-50 transition-colors">
                  <div>
                     <div className="flex items-center gap-2 mb-1">
                        <span className="font-bold text-base text-slate-800">{p.name}</span>
                        {p.currentQuantity === 0 && <span className="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded">售罄</span>}
                     </div>
                     <div className="text-xs text-slate-500 flex gap-3">
                        <span>成本 {formatCurrency(p.costPrice)}</span>
                        <span>初始 {p.initialQuantity}</span>
                     </div>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                     <span className={`text-xl font-bold font-mono ${p.currentQuantity < 3 ? 'text-red-500' : 'text-primary'}`}>
                       {p.currentQuantity}
                     </span>
                     <span className="text-[10px] text-slate-400">剩余</span>
                  </div>
                  {p.currentQuantity === p.initialQuantity && (
                    <button onClick={(e) => {e.stopPropagation(); if(confirm('删除此商品？')) onDelete(p.id)}} className="absolute top-0 right-0 p-3 text-slate-300 hover:text-red-500">
                       <Icons.Common.Trash className="w-4 h-4"/>
                    </button>
                  )}
               </Card>
             ))}
          </div>

          <FAB onClick={() => setModalOpen(true)} icon={<Icons.Common.Plus className="w-8 h-8"/>} />

          <ModalSheet isOpen={isModalOpen} onClose={() => setModalOpen(false)} title="入库新商品">
             <div className="space-y-4">
                <Input label="商品名称" placeholder="例如：iPhone 15 Pro" value={form.name} onChange={e => setForm({...form, name: e.target.value})} autoFocus/>
                <div className="flex gap-4">
                   <Input label="成本单价" type="number" placeholder="0.00" value={form.cost} onChange={e => setForm({...form, cost: e.target.value})}/>
                   <Input label="入库数量" type="number" placeholder="1" value={form.qty} onChange={e => setForm({...form, qty: e.target.value})}/>
                </div>
                <Button onClick={handleSubmit} className="w-full bg-primary text-white text-lg">确认入库</Button>
             </div>
          </ModalSheet>
        </div>
      );
    };

    // 3. Sales (Cart)
    const SalesView = ({ products, onSell }) => {
      const [cart, setCart] = useState([]);
      const [selectedId, setSelectedId] = useState('');
      const [qty, setQty] = useState('1');
      const [price, setPrice] = useState('');
      const [step, setStep] = useState(1);
      const [checkoutInfo, setCheckoutInfo] = useState({ buyer:'', track:'', ship:'' });

      const selectedProduct = products.find(p => p.id === selectedId);
      const available = selectedProduct ? (selectedProduct.currentQuantity - cart.filter(c=>c.pid===selectedId).reduce((a,b)=>a+b.qty,0)) : 0;

      const addToCart = () => {
         if(!selectedId || !price || Number(qty) <= 0 || Number(qty) > available) return;
         setCart([...cart, { 
            tempId: generateId(), pid: selectedId, name: selectedProduct.name, 
            cost: selectedProduct.costPrice, price: Number(price), qty: Number(qty) 
         }]);
         setSelectedId(''); setQty('1'); setPrice('');
      };

      const doSell = () => {
         onSell(cart, checkoutInfo);
         setCart([]); setStep(1); setCheckoutInfo({buyer:'', track:'', ship:''});
      };

      const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);
      const profit = cart.reduce((a,b) => a + ((b.price - b.cost) * b.qty), 0);

      return (
        <div className="min-h-screen pb-safe-extra">
           <header className="px-5 py-3 sticky top-0 z-20 bg-background/95 backdrop-blur border-b border-slate-200/50 flex justify-between items-center h-[50px] mb-2">
              <h1 className="text-lg font-bold text-slate-900">记账</h1>
              {cart.length > 0 && <span className="bg-primary text-white text-xs px-2 py-0.5 rounded-full font-bold">{cart.length}</span>}
           </header>

           {step === 1 && (
             <div className="px-4 space-y-6">
               <div className="bg-white p-5 rounded-2xl shadow-card space-y-4">
                  <div>
                    <label className="text-sm font-medium text-slate-500 ml-1">选择商品</label>
                    <Select value={selectedId} onChange={e=>setSelectedId(e.target.value)}>
                      <option value="">点击选择...</option>
                      {products.filter(p=>p.currentQuantity>0).map(p => {
                         const inCart = cart.filter(c=>c.pid===p.id).reduce((a,b)=>a+b.qty,0);
                         const realAvail = p.currentQuantity - inCart;
                         return <option key={p.id} value={p.id} disabled={realAvail<=0}>{p.name} (余{realAvail})</option>;
                      })}
                    </Select>
                  </div>
                  {selectedId && (
                    <div className="grid grid-cols-2 gap-4 animate-fade-in">
                       <Input label="卖出单价" type="number" placeholder="0.00" value={price} onChange={e=>setPrice(e.target.value)} />
                       <Input label={`数量 (最大${available})`} type="number" value={qty} onChange={e=>setQty(e.target.value)} />
                    </div>
                  )}
                  <Button disabled={!selectedId || available<=0} onClick={addToCart} className="w-full bg-primary disabled:bg-slate-300 text-white">
                     加入待售
                  </Button>
               </div>

               {cart.length > 0 && (
                 <div className="space-y-3">
                   <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">已选商品</h3>
                   {cart.map(item => (
                     <div key={item.tempId} className="bg-white p-4 rounded-xl flex justify-between items-center shadow-card animate-slide-up">
                        <div>
                           <div className="font-bold">{item.name}</div>
                           <div className="text-xs text-slate-500">{formatCurrency(item.price)} x {item.qty}</div>
                        </div>
                        <div className="flex items-center gap-3">
                           <span className="font-mono font-medium text-primary">{formatCurrency(item.price * item.qty)}</span>
                           <button onClick={() => setCart(cart.filter(c=>c.tempId!==item.tempId))}><Icons.Common.XMark className="w-5 h-5 text-slate-300"/></button>
                        </div>
                     </div>
                   ))}
                 </div>
               )}
             </div>
           )}

           {step === 2 && (
             <div className="px-4 space-y-4 animate-slide-up">
                <button onClick={() => setStep(1)} className="text-sm text-slate-500 flex items-center gap-1 mb-2">← 返回修改</button>
                <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                   <div className="flex justify-between text-emerald-800 font-bold mb-2"><span>预计利润</span><span>{formatCurrency(profit)}</span></div>
                   <div className="flex justify-between text-sm text-emerald-600"><span>销售总额</span><span>{formatCurrency(total)}</span></div>
                </div>
                <div className="bg-white p-5 rounded-2xl shadow-card space-y-4">
                   <h3 className="font-bold text-sm">备注信息</h3>
                   <Input label="买家昵称" value={checkoutInfo.buyer} onChange={e=>setCheckoutInfo({...checkoutInfo, buyer:e.target.value})} />
                   <Input label="快递单号" value={checkoutInfo.track} onChange={e=>setCheckoutInfo({...checkoutInfo, track:e.target.value})} />
                   <Input label="快递运费 (不计利润)" type="number" value={checkoutInfo.ship} onChange={e=>setCheckoutInfo({...checkoutInfo, ship:e.target.value})} />
                </div>
             </div>
           )}
           
           {cart.length > 0 && (
             <div className="fixed bottom-[calc(4rem+env(safe-area-inset-bottom))] left-0 right-0 p-3 bg-white border-t border-slate-100 z-20">
                <div className="flex items-center gap-4 px-2">
                   <div className="flex-1">
                      <div className="text-xs text-slate-500">合计</div>
                      <div className="text-xl font-bold text-primary font-mono">{formatCurrency(total)}</div>
                   </div>
                   {step === 1 ? (
                     <Button onClick={()=>setStep(2)} className="bg-primary text-white shadow-lg shadow-emerald-100">下一步</Button>
                   ) : (
                     <Button onClick={doSell} className="bg-slate-900 text-white shadow-lg">确认出售</Button>
                   )}
                </div>
             </div>
           )}
        </div>
      );
    };

    // 4. History
    const HistoryView = ({ sales }) => {
      const grouped = useMemo(() => {
        const g = {};
        sales.forEach(s => {
           const id = s.transactionId || s.soldAt;
           if(!g[id]) g[id] = [];
           g[id].push(s);
        });
        return Object.values(g).sort((a,b) => b[0].soldAt - a[0].soldAt);
      }, [sales]);

      return (
        <div className="pb-safe min-h-screen">
           <header className="px-5 py-3 sticky top-0 z-20 bg-background/95 backdrop-blur border-b border-slate-200/50 flex justify-between items-center h-[50px] mb-2">
              <h1 className="text-lg font-bold text-slate-900">账单明细</h1>
           </header>
           <div className="px-4 space-y-4">
              {grouped.length === 0 && <div className="text-center py-20 text-slate-400">暂无记录</div>}
              {grouped.map((group, i) => {
                 const first = group[0];
                 const totalP = group.reduce((a,b)=>a+b.profit,0);
                 const totalS = group.reduce((a,b)=>a+b.totalSellPrice,0);
                 const ship = group.reduce((a,b)=>a+(b.shippingCost||0),0);
                 
                 return (
                   <Card key={i} className="space-y-3">
                      <div className="flex justify-between items-center pb-2 border-b border-slate-50">
                         <div className="text-xs text-slate-400 flex items-center gap-1">
                            {new Date(first.soldAt).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}
                         </div>
                         <div className={`font-bold font-mono ${totalP>=0?'text-primary':'text-red-500'}`}>
                            {totalP>0?'+':''}{formatCurrency(totalP)}
                         </div>
                      </div>
                      <div className="space-y-2">
                         {group.map(item => (
                            <div key={item.id} className="flex justify-between items-center">
                               <div className="text-sm font-medium text-slate-700">{item.productName} <span className="text-slate-400 text-xs">x{item.quantity}</span></div>
                               <div className="text-sm font-mono text-slate-500">{formatCurrency(item.totalSellPrice)}</div>
                            </div>
                         ))}
                      </div>
                      <div className="pt-2 border-t border-slate-50 flex justify-between items-center text-xs">
                         <div className="text-slate-400">
                            {first.buyerName && <span className="mr-2 text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded">{first.buyerName}</span>}
                            {first.trackingNumber && <span>{first.trackingNumber}</span>}
                         </div>
                         <div className="font-bold text-slate-600">实收 {formatCurrency(totalS + ship)}</div>
                      </div>
                   </Card>
                 )
              })}
           </div>
        </div>
      );
    };

    // --- MAIN APP ---
    const App = () => {
      const [tab, setTab] = useState('DASHBOARD');
      const [data, setData] = useState(() => {
         try { return JSON.parse(localStorage.getItem('resell_app_data_v3')) || { products:[], sales:[] }; }
         catch { return { products:[], sales:[] }; }
      });
      const [showSettings, setShowSettings] = useState(false);

      useEffect(() => localStorage.setItem('resell_app_data_v3', JSON.stringify(data)), [data]);

      const actions = {
        addProduct: (p) => {
           setData(prev => ({ ...prev, products: [{ ...p, id: generateId(), currentQuantity: p.initialQuantity, createdAt: Date.now() }, ...prev.products] }));
        },
        deleteProduct: (id) => {
           setData(prev => ({ ...prev, products: prev.products.filter(p => p.id !== id) }));
        },
        addSales: (items, info) => {
           const tid = generateId();
           const now = Date.now();
           const newSales = items.map((item, idx) => ({
              id: generateId(), transactionId: tid, productId: item.pid, productName: item.name,
              unitCostPrice: item.cost, unitSellPrice: item.price, quantity: item.qty,
              totalSellPrice: item.price * item.qty, profit: (item.price - item.cost) * item.qty,
              soldAt: now, buyerName: info.buyer, trackingNumber: info.track, shippingCost: idx===0 ? Number(info.ship||0) : 0
           }));
           // Update Inventory
           const qtyMap = {}; items.forEach(i => qtyMap[i.pid] = (qtyMap[i.pid]||0) + i.qty);
           setData(prev => ({
              products: prev.products.map(p => qtyMap[p.id] ? {...p, currentQuantity: p.currentQuantity - qtyMap[p.id]} : p),
              sales: [...newSales, ...prev.sales]
           }));
           setTab('HISTORY');
        },
        importData: (e) => {
           const f = e.target.files?.[0]; if(!f) return;
           const r = new FileReader();
           r.onload = (ev) => {
              try {
                 const d = JSON.parse(ev.target.result);
                 if(d.products && d.sales && confirm('确定覆盖当前数据？')) { setData(d); setShowSettings(false); alert('导入成功'); }
              } catch(err) { alert('文件无效'); }
           };
           r.readAsText(f);
        }
      };

      const NavBtn = ({ id, Outline, Solid, label }) => {
        const isActive = tab === id;
        const Icon = isActive ? Solid : Outline;
        return (
          <button onClick={() => setTab(id)} className="flex-1 flex flex-col items-center justify-center gap-0.5 active:bg-slate-50 transition-colors h-full">
             <Icon className={`w-7 h-7 transition-all ${isActive ? 'text-primary' : 'text-textMain'}`}/>
             <span className={`text-[11px] font-medium ${isActive ? 'text-primary' : 'text-textMain'}`}>{label}</span>
          </button>
        );
      };

      return (
        <div className="max-w-lg mx-auto bg-background min-h-screen relative shadow-2xl">
           {/* Global Header for Safe Area Top - Only used as a spacer/container for top actions */}
           <header className="fixed top-0 left-0 right-0 z-50 pointer-events-none pt-[env(safe-area-inset-top)]">
              <div className="max-w-lg mx-auto relative h-14">
                 <button onClick={() => setShowSettings(true)} className="absolute right-4 top-2 pointer-events-auto p-2 bg-white/80 backdrop-blur rounded-full shadow-sm text-slate-600 hover:text-slate-900 z-50">
                    <Icons.Common.Settings className="w-5 h-5"/>
                 </button>
              </div>
           </header>

           {/* Add top padding to body content to account for safe area if needed, but views handle it */}
           <main className="min-h-screen pt-[env(safe-area-inset-top)]">
             {tab === 'DASHBOARD' && <DashboardView products={data.products} sales={data.sales} />}
             {tab === 'INVENTORY' && <InventoryView products={data.products} onAdd={actions.addProduct} onDelete={actions.deleteProduct} />}
             {tab === 'SALES' && <SalesView products={data.products} onSell={actions.addSales} />}
             {tab === 'HISTORY' && <HistoryView sales={data.sales} />}
           </main>

           <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex flex-col justify-end z-30 max-w-lg mx-auto pb-[env(safe-area-inset-bottom)]">
              <div className="flex items-center h-14 w-full">
                 <NavBtn id="DASHBOARD" Outline={Icons.Outline.Home} Solid={Icons.Solid.Home} label="概览" />
                 <NavBtn id="INVENTORY" Outline={Icons.Outline.Box} Solid={Icons.Solid.Box} label="库存" />
                 <NavBtn id="SALES" Outline={Icons.Outline.PlusCircle} Solid={Icons.Solid.PlusCircle} label="记账" />
                 <NavBtn id="HISTORY" Outline={Icons.Outline.Clock} Solid={Icons.Solid.Clock} label="账单" />
              </div>
           </nav>

           <ModalSheet isOpen={showSettings} onClose={() => setShowSettings(false)} title="数据管理">
              <div className="space-y-4 pb-6">
                 <button onClick={() => actions.exportData(data, 'backup')} className="w-full p-4 bg-slate-50 rounded-xl flex items-center gap-3 font-medium text-slate-700 active:bg-slate-100">
                    <Icons.Common.ArrowDown className="w-6 h-6 text-primary"/> 备份数据
                 </button>
                 <div className="relative">
                    <input type="file" onChange={actions.importData} className="absolute inset-0 opacity-0 z-10" />
                    <button className="w-full p-4 bg-slate-50 rounded-xl flex items-center gap-3 font-medium text-slate-700 active:bg-slate-100">
                       <Icons.Common.ArrowUp className="w-6 h-6 text-blue-500"/> 恢复数据
                    </button>
                 </div>
              </div>
           </ModalSheet>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
